include makefile.conf

include ../common/Files.common
CPPSRC += $(SRC_COMMON)
include ./Files

########################
# choosing the port should be more dynamic than this
CSRC += ./3rdparty/FreeRTOS/portable/GCC/ARM_CM3/port.c
INCLUDES += ./3rdparty/FreeRTOS/portable/GCC/ARM_CM3

#CSRC += ./3rdparty/FreeRTOS/portable/MPLAB/PIC32MX/port.c
#ASMSRC += ./3rdparty/FreeRTOS/portable/MPLAB/PIC32MX/port_asm.S
#INCLUDES += ./3rdparty/FreeRTOS/portable/MPLAB/PIC32MX/

COBJ1 =$(addprefix OBJS/,$(notdir $(CSRC)))
COBJ=$(COBJ1:.c=.o)
CPPOBJ1 =$(addprefix OBJS/,$(notdir $(CPPSRC)))
CPPOBJ=$(CPPOBJ1:.cc=.o)

CHECK_FILES = $(CPPSRC) $(CHECK_HDRS)

ALLOBJ=$(COBJ) $(CPPOBJ)
INCLUDES += $(CINCS) $(CPPINCS)
INCS=$(addprefix -I ,$(INCLUDES))


.PHONY: prepare depend all clean tests doc checkformat
all: prepare libopenpearl.a include

tests: all
	(cd tests; make; cd ..)

checkformat:
	@$(foreach f,$(CHECK_FILES),../codestyle/check.sh $(f);)
	make -C tests checkformat

doc:
	doxygen doc_stuff/Doxyfile

#########################
# compile C related stuff
define C_TEMPLATE
OBJS/$(notdir $(basename $(1))).o: $(1)
	@echo "compile C-File:" $(notdir $(1))
	@$(CROSS)$(CC) $$(CFLAGS) $(INCS) -c $$< -o $$@
endef
$(foreach src, $(CSRC), $(eval $(call C_TEMPLATE, $(src))))
#########################
#########################
# compile C++ related stuff
define CPP_TEMPLATE
OBJS/$(notdir $(basename $(1))).o: $(1) depend
	@echo "compile C++-File:" $(notdir $(1))
	@$(CROSS)$(CXX) $$(CXXFLAGS) $(INCS) -c $$< -o $$@
endef
$(foreach src, $(CPPSRC), $(eval $(call CPP_TEMPLATE, $(src))))
#########################


prepare:
	@echo "[create directory for objects]"
	@mkdir -p OBJS

depend: $(CSRC) $(CPPSRC)
	@echo "[setup dependencies]"
	@$(CROSS)$(CXX) -MM $^ $(CFLAGS) $(INCS) $(NXPCFLAGS) > .depends

libopenpearl.a: $(ALLOBJ)
	@echo "[update libPEARL90.a]"
	@$(CROSS)$(AR) rs $@ $^

include:
	@echo "[collect headers for library]"
	echo $(INCLUDES)
	mkdir -p include
	cp $(addsuffix /*.h,$(INCLUDES)) include
	cp ../common/Signals.hh include
# copy Clock.h, too


# --------------------------------------------------
# additional rules to enable make to build the autogenerated files
#
../common/Signals.hh: ../common/Signals.ods
	(cd ../common; perl -X GenerateSignalDefinitions.pl GENERIC;)

../common/Signals.hcc: ../common/Signals.ods
	(cd ../; perl -X GenerateSignalDefinitions.pl GENERIC;)

../common/Signals.cc: ../common/Signals.hh ../common/Signals.hcc

# -----------------------------------
clean: 
	rm -f cpp.elf *.map
	rm -rf OBJS
	rm -f *.o libopenpearl.a *.new *.diff
	rm -f ../common/Signals.hh ../common/Signals.hcc 
	rm -f ../common/*.new ../common/*.diff
	rm -f ../FreeRTOS/*.new ../FreeRTOS/*.diff
	rm -rf latex html include
#	(cd tests; make clean; cd ..)

-include .depend
