include makefile.conf

include ../common/Files.common
CPPSRC += $(SRC_COMMON)
include ../FreeRTOS_V8.1.2/Files
include ../FreeRTOS/Files
include ./Files

CSRC+=AsciiLib.c

COBJ1 =$(addprefix OBJS/,$(notdir $(CSRC)))
COBJ=$(COBJ1:.c=.o)
CPPOBJ1 =$(addprefix OBJS/,$(notdir $(CPPSRC)))
CPPOBJ=$(CPPOBJ1:.cc=.o)

CHECK_FILES = $(CPPSRC) $(CHECK_HDRS)

CXXFLAGS4SUB = $(CXXFLAGS)
LFLAGS4SUB =$(LFLAGS)

ALLOBJ=$(COBJ) $(CPPOBJ) startup_ARMCM3.o
INCLUDES = $(CINCS) $(CPPINCS)
INCS=$(addprefix -I ,$(INCLUDES))
INCLUDES4SUB = $(INCLUDES)

export CXXFLAGS4SUB LFLAGS4SUB INCLUDES4SUB

.PHONY: prepare all clean tests doc checkformat
all: prepare depend plib1.a plib.a

tests: all
	(cd tests; make; cd ..)

checkformat:
	@$(foreach f,$(CHECK_FILES),../codestyle/check.sh $(f);)
	make -C tests checkformat

doc:
	doxygen doc_stuff/Doxyfile

#########################
# compile simple C stuff, which needs no  NPX-include settings
define C_TEMPLATE
OBJS/$(notdir $(basename $(1))).o: $(1)
	@echo "compile C-File:" $(notdir $(1))
	@$(CC) $$(CFLAGS) $(INCS) -c $$< -o $$@
endef
$(foreach src, $(CSRC), $(eval $(call C_TEMPLATE, $(src))))
#########################
#########################
# compile C++ related stuff
define CPP_TEMPLATE
OBJS/$(notdir $(basename $(1))).o: $(1)
	@echo "compile C++-File:" $(notdir $(1))
	@$(CXX) $$(CXXFLAGS) $(INCS) -c $$< -o $$@
endef
$(foreach src, $(CPPSRC), $(eval $(call CPP_TEMPLATE, $(src))))
#########################


prepare:
	@echo "[create directory for objects]"
	@mkdir -p OBJS

depend: $(CSRC) $(CPPSRC)
#	@echo "ALLOBJ:"
#	@echo $(ALLOBJ)
#	@echo "CSRC:"
#	@echo $(CSRC)
#	@echo "CPPSRC:"
#	@echo $(CPPSRC)
#	@echo "INCS:"
#	@echo $(INCS)
	@echo "[setup dependencies]"
	@$(CXX) -MM $^ $(CFLAGS) $(INCS) $(NXPCFLAGS) > .depends
	
startup_ARMCM3.o: startup_ARMCM3.S
	@echo "[assemble] startup_ARMCM3.S"
	@$(CC) $^ $(CFLAGS) -c 
#	@$(CC) $^ $(CFLAGS) -D__NO_SYSTEM_INIT -c 

plib.a:  $(ALLOBJ)
	@echo "[update plib.a]"
	@$(AR) rs $@ $^

plib1.a: plib.a
	@echo "[create plib1.a (without main()]"
	@cp plib.a plib1.a
	@$(AR) d plib1.a OBJS/main.o

# --------------------------------------------------
# additional rules to enable make to build the autogenerated files
#
../common/Signals.hh: ../common/Signals.ods
	(cd ../common; perl GenerateSignalDefinitions.pl GENERIC;)

../common/Signals.hcc: ../common/Signals.ods
	(cd ../; perl GenerateSignalDefinitions.pl GENERIC;)

../common/Signals.cc: ../common/Signals.hh ../common/Signals.hcc

#cpp.elf: $(PEARLCPPOBJ) $(NXPOBJ) $(COBJ) startup_ARMCM3.o
#cpp.elf: OBJS/cpp.o OBJS/systeminit.o plib.a
#	@echo "[linking] "  $@ 
#	@echo "   [adding] " $(PEARLCPPOBJ)
#	@echo "   [adding] " $(NXPOBJ) 
#	@echo "   [adding] " $(COBJ)
#	@echo "   [adding] " startup_ARMCM3.o
#	$(CXX) $(CXXFLAGS) $(LFLAGS) $^ -o $@


# -----------------------------------

DataTypeTests: tests/DataTypeTests.hex
	lpc21isp -control -term -hex $< /dev/ttyUSB0 115200 12000

cpp: tests/cpp.hex
	lpc21isp -control -term -hex $< /dev/ttyUSB0 115200 12000

firsttest: tests/firsttest.hex
	lpc21isp -control -term -hex $< /dev/ttyUSB0 115200 12000

# -----------------------------------
clean: 
	rm -f cpp.elf *.map
	rm -rf OBJS
	rm -f *.o plib.a plib1.a *.new *.diff
	rm -f ../common/Signals.hh ../common/Signals.hcc 
	rm -f ../common/*.new ../common/*.diff
	rm -f ../FreeRTOS/*.new ../FreeRTOS/*.diff
	rm -rf latex html
	(cd tests; make clean; cd ..)

-include .depend
