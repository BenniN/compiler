#/*
# [The "BSD license"]
# Copyright (c) 2012-2013 Rainer Mueller
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. The name of the author may not be used to endorse or promote products
#    derived from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
# OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
# IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
# NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
# THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#*/

# pearl runtime system

INCLUDES = -I . -I ../common
_CXXFLAGS = -Wall -g  -fstack-protector
_CXXFLAGS += -pthread
_CXXFLAGS += -fno-non-call-exceptions
CXXFLAGS = $(INCLUDES) $(_CXXFLAGS)
LDFLAGS = -lpthread -lrt 

# helper commands include composer, deleted white spaces
IC_DIR = ../includeComposer
IC = $(IC_DIR)/ic
DWS = $(IC_DIR)/dws

#only for octopus at90
#-lusb -loctopus 

DEPENDFILE = .depend

# import lists of common files for all implementations
include ../common/Files.common

SRCANDH = \
	TaskTimer.cc \
	Task.cc \
	Mutex.cc PrioMapper.cc \
	CSema.cc \
	Pipe.cc Disc.cc StdStream.cc \
	UnixSignal.cc \
	Clock.cc  

#TaskList.cc \
#	FileSource.cc FileSink.cc \

SRCONLY =os.cc \
	TaskMonitor.cc \
	Log.cc  


SRC = $(SRCANDH) $(SRCONLY)

ALL_SRCS = $(SRC) $(SRC_COMMON)

SRC_H = $(SRCANDH:%.cc=%.h) PearlIncludes.h  $(HDR_COMMON)

OBJS = $(ALL_SRCS:%.cc=%.o)
# ----------------------------------------
# file lists for tests - init values
# these values are extended in tests/Makefile

TESTS =
TEST_SRCS =
TEST_DATION_SRCS =
GTEST_SRCS =

# ---------------------------------------


# --------------------
# select desired drivers for the installation
# only drivers which compile on all machines may be selected 
# at commit!
#DRIVERS = Octopus
DRIVERS =

#
CHECK_FILES = $(sort $(SRC) $(SRCONLY) $(SRC_H) $(SRC_COMMON) $(HDR_COMMON))

.PHONY: clean depend help all doc drivers tests

# -----------------------------------
# add driver specific stuff to file lists
$(warning Info: DRIVERS=$(DRIVERS))

ifeq (Octopus,$(DRIVERS)) 
	SRC += drivers/Octopus.cc
	SRC += drivers/OctopusDigitalOut.cc
	SRC += drivers/OctopusDigitalIn.cc
	CHECK_FILES += drivers/Octopus.cc drivers/Octopus.h
	CHECK_FILES += drivers/OctopusDigitalOut.cc drivers/OctopusDigitalOut.h
	CHECK_FILES += drivers/OctopusDigitalIn.cc drivers/OctopusDigitalIn.h
	INCLUDES += -I ./drivers 
	INCLUDES += -I ../drivers 
	TEST_DATION_SRCS += OctopusDigitalOutTest.cc
	TEST_DATION_SRCS += OctopusDigitalInOutTest.cc
	LDFLAGS +=  -lusb -loctopus
else
endif
#$(warning Info: SRC=$(SRC))
#$(warning Info: LDFLAGS=$(LDFLAGS))
#$(warning Info: CXXFLAGS=$(CXXFLAGS))
#$(warning Info: TEST_DATION_SRCS=$(TEST_DATION_SRCS))

CXXFLAGS4SUB = $(_CXXFLAGS) $(INCLUDES) 
LDFLAGS4SUB = $(LDFLAGS)
export CXXFLAGS4SUB LDFLAGS4SUB 
export TEST_SRCS TEST_DATION_SRCS GTEST_SRCS 

all: depend  plib.a

help:
	@echo "-----------------"
	@echo "make all         : build the pearl library plib.a"
	@echo "make clean       : remove all generated files"
	@echo "make checkformat : apply code style checks"
	@echo "make doc         : generate Doxygen documentation in HTML"
	@echo "make tests       : build the test programs in ./tests"
	@echo "make install     : install to /usr/local/lib and /usr/local/include"
	@echo "-----------------"
	@echo

tests:  all
	make -C tests

install: all
	(cd $(IC_DIR); make;)
	rm -f pearl.h
	$(IC) -c $(INCLUDES)  <PearlIncludes.h | $(DWS) >pearl.h
	cat ../LICENSE.BSD sysincs.h pearl.h >/usr/local/include/PearlIncludes.h
	cp plib.a /usr/local/lib
	rm -f pearl.h sysincs.h

drivers:
	$(foreach f,$(DRIVERS), make -C drivers $(f);)

plib.a: $(OBJS)
	ar r plib.a $(OBJS) 
# --------------------------------------------------
# additional rules to enable make to build the autogenerated files
#
../common/Signals.hh: ../common/Signals.ods
	(cd ../common; perl GenerateSignalDefinitions.pl GENERIC LINUX;)

../common/Signals.hcc: ../common/Signals.ods
	(cd ../; perl GenerateSignalDefinitions.pl GENERIC LINUX;)

../Signals.cc: ../Signals.hh ../Signals.hcc

#---------------------------------------------------------
clean: 
	rm -f $(OBJS)
	rm -f pearl_log.txt
	rm -f plib.a
	rm -rf latex
	rm -rf html
	rm -rf .depend
	rm -f ../common/tests/*.new
	rm -f ../common/tests/*.diff
	rm -f ../common/*.new
	rm -f ../common/*.diff
	rm -f *.new
	rm -f *.diff
	rm -f *.log
	rm -f drivers/*.new
	rm -f drivers/*.diff
	rm -f core
	rm -f ../common/Signals.hh ../common/Signals.hcc
	rm -f ../common/signallist.tex 
	rm -f ../common/sysincs.h 
	(cd $(IC_DIR); make clean;)
	make -C tests clean

checkformat: 
	@$(foreach f,$(CHECK_FILES),../codestyle/check.sh $(f);)
	make -C tests checkformat

doc:
	doxygen doc_stuff/Doxyfile
#	(cd latex; make pdf; cd ..)


depend: $(ALL_SRCS) ../common/Signals.hh ../common/Signals.hcc
	$(CC) -MM  $(INCLUDES) $(ALL_SRCS) > $(DEPENDFILE)

-include .depend
