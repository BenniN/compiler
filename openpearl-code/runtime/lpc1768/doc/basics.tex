\section{System Overview}
FreeRTOS is used as scheduler. Processor specific parts are
realized with the help of LPCOpen. LTO ist used.

All system specific parts are located in \texttt{./lpc1768}. 
These componts are:
Makefile, linker script, peripheral dependent stuff like real time clock,..

All objects are packed in the PEARL-library 
\verb|libOpenPEARLlpc1768.a|. The \texttt{weak} symbols are
packed into \texttt{OpenPEARLlpc1768\_board.o}.

\section{System Initialization}
The system initialization  is controlled by the following files:
\begin{description}
\item[lpc1768/OpenPEARLlpc1768.ld] is the linker script. This files is derived from
   the samples from the Launchpad cross-tool-chain file gcc.ld. 
   Only the ram and rom sizes were modified to fit the LPC1768 
\item[lpc1768/startup\_lpc1768.S] contains the interrupt vector table and the 
   reset handling routine. The reset handler 
   \begin{enumerate}
   \item copies the preset values from flash memory to RAM
   \item clears the BSS section 
   \item  calls the SystemInit() function
   \item  branches to the initialization of glibc (\_start); glibc
      initializes inself and the static objects and branches into \verb|main()|
   \end{enumerate}
\item[lpc1768/lpc17\_SystemInit.c] contains the actions, which must be executed
   before the clib is started. Up to now only the systems core clock is 
   set.
\item [lpc1768/lpc17\_uart\_retarget.c] contains some functions, which redirects console 
   input and output to the UART0.  This allows the use of printf(), 
   scanf(), cin and cout in the application. The UART initialization is done 
   upon first usage of any i/o-operation of this module.
\item[FreeRTOS/PEARL/main.cc] contains the application start code.
 The major steps are:
  \begin{enumerate}
  \item send a list of defined tasks to the Log::debug-interface
  \item activate all \verb|MAIN| tasks according their priority
  \item initialize the real time clock (RTC)
  \item initialize the software time from the RTC
  \item start the FreeRTOS scheduler 
  \end{enumerate}
  The termination is done in the class \verb|TaskMonitor|. 
\end{description}

\section{Interrupt Levels}
The Cortex-M systems provide different interrupt levels for peripheral devices.
The FreeRTOS system requires that interrupt service routines, which call
FreeRTOS function have the interrupt level 
\texttt{configMAX\_SYSCALL\_INTERRUPT\_PRIORITY} or worse. 
This must be regarded in each driver of a peripheral device.

\section{Principle of the Time Base}
The LPC1768 is a Cortex-M processor. FreeRTOS uses the systick timer 
for the sytem tick interrupt. 
\begin{description}
\item[FreeRTOS/addOns/CortexMclock.cc] provides a more precise value to
 the current time than on tick.
This is done
by the calulation of the fraction, which is passed in the current tick.
This calulation is based on the Cortex-M specific systick registers
{\em SYSTICK\_CURRENT\_VALUE\_REG} and {\em SYSTICK\_LOAD\_REG}.
\item[lpc17/Lpc17xxRTC.cc] provides a system time base, which is 
initialized with the RTC value at system start.
\item[lpc17/Lpc17xxTimer0.cc] provides a system time base, which works 
with the TIMER0.
\end{description}

\section{System Time Base Selection}
Lpc17xxClock provides a pseudo device in order
   to specify the time base for the PEARL application individually. E.g.

\begin{verbatim}
SYSTEM;
  myClock: Lpc17xxClock(1);  ! start with the time in the RTC
\end{verbatim}

The following modes are avaliable:
\begin{description}
\item[Lpc17xxClock(0)] the default time base. It starts at 1.1.1970 0:00
   and works with the systick based relative ticks with a resolution of 1 ms.
\item[Lpc17xxClock(1)] is similar to Lpc17xxClock(1), but it provides
   interpolated time values  for the \texttt{NOW}-function 
   from the registers of the systick timer.
\item[Lpc17xxClock(2)] differs from \texttt{Lpc17xxClock(1)} by the fact 
    that the initial date and time is taken from the RTC.
    In case that the RTC does not contain a useful value, the RTC
    is initialized with the default date of 1.1.2016 0:0:0.
    If the RTC does not start, the programs exits.
\item[Lpc17xxClock(3)] operates with a separate timer. This method
    provides a clock resolution of $10 \mu s$. The initial time is taken
    from the RTC like described in \texttt{Lpc17xxClock(2)}.
\item[Lpc17xxClock(4)] is similar to \texttt{Lpc17xxClock(3)}. 
    The difference is a synchronisation to the 1 seconds tick of the RTC.
    This causes small drifts in frequency but there is no gap in time 
    between resets. The synchronisation starts after 2 seconda.
    It takes approximatelly  5 seconds to enshure a time difference of
     less that $10\mu s$.
\end{description}

The preferred clocks are 
\begin{itemize}
\item \texttt{Lpc17xxClock(3)} for closed loop control systems
\item \texttt{Lpc17xxClock(4)} for open loop control systems
\end{itemize} 


\section{Power-On-Self-Test (POST)}
This module provides some information about the system usage.

Tests are not implemented yet.

The POST may be selected via a pseudo device in the systempart of the 
OpenPEARL application.

\begin{description}
\item[Post(0)] invokes the POST module to display the POST status
\item[Post(1)] in addition to Post(0), the module wait for user input
   to e.q. set the RTC
\end{description}


