MODULE(pcf9685);
SYSTEM;
  i2cbus : I2CBus('/dev/i2c-0');
  pcfProvider:     PCF9685('40'B4,30) --- i2cbus;
! next two lines are not accepted by the compiler
!  pcf    : PCF9685Channel(0) --- PCF9685('40'B4,30) --- I2CBus('/dev/i2c-0');
!  pcf    : PCF9685Channel(0) --- PCF9685('40'B4,30) --- i2cbus;
  pcf0    : PCF9685Channel(0) --- pcfProvider;
  pcf1    : PCF9685Channel(1) --- pcfProvider;
  pcf2    : PCF9685Channel(2) --- pcfProvider;
  pcf3    : PCF9685Channel(3) --- pcfProvider;
  pcf4    : PCF9685Channel(4) --- pcfProvider;
  pcf5    : PCF9685Channel(5) --- pcfProvider;
  pcf6    : PCF9685Channel(6) --- pcfProvider;
  pcf7    : PCF9685Channel(7) --- pcfProvider;
  pcf8    : PCF9685Channel(8) --- pcfProvider;
  pcf9    : PCF9685Channel(9) --- pcfProvider;
  pcf10   : PCF9685Channel(10) --- pcfProvider;
  pcf11   : PCF9685Channel(11) --- pcfProvider;
  pcf12   : PCF9685Channel(12) --- pcfProvider;
  pcf13   : PCF9685Channel(13) --- pcfProvider;
  pcf14   : PCF9685Channel(14) --- pcfProvider;
  pcf15   : PCF9685Channel(15) --- pcfProvider;
  termout: StdOut;
  termin: StdIn;

PROBLEM;
  SPC termout DATION OUT SYSTEM ALPHIC GLOBAL;
  SPC termin  DATION IN  SYSTEM ALPHIC GLOBAL;
  SPC pcf0    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf1    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf2    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf3    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf4    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf5    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf6    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf7    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf8    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf9    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf10    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf11    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf12    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf13    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf14    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
  SPC pcf15    DATION OUT  SYSTEM BASIC FIXED(15) GLOBAL;
   

DCL consol DATION OUT ALPHIC DIM(*,80) FORWARD NOSTREAM CREATED(termout);
DCL consil  DATION IN ALPHIC DIM(*,80) FORWARD NOSTREAM CREATED(termin);
DCL myPcf0 DATION OUT BASIC FIXED(15) CREATED(pcf0);
DCL myPcf1 DATION OUT BASIC FIXED(15) CREATED(pcf1);
DCL myPcf2 DATION OUT BASIC FIXED(15) CREATED(pcf2);
DCL myPcf3 DATION OUT BASIC FIXED(15) CREATED(pcf3);
DCL myPcf4 DATION OUT BASIC FIXED(15) CREATED(pcf4);
DCL myPcf5 DATION OUT BASIC FIXED(15) CREATED(pcf5);
DCL myPcf6 DATION OUT BASIC FIXED(15) CREATED(pcf6);
DCL myPcf7 DATION OUT BASIC FIXED(15) CREATED(pcf7);
DCL myPcf8 DATION OUT BASIC FIXED(15) CREATED(pcf8);
DCL myPcf9 DATION OUT BASIC FIXED(15) CREATED(pcf9);
DCL myPcf10 DATION OUT BASIC FIXED(15) CREATED(pcf10);
DCL myPcf11 DATION OUT BASIC FIXED(15) CREATED(pcf11);
DCL myPcf12 DATION OUT BASIC FIXED(15) CREATED(pcf12);
DCL myPcf13 DATION OUT BASIC FIXED(15) CREATED(pcf13);
DCL myPcf14 DATION OUT BASIC FIXED(15) CREATED(pcf14);
DCL myPcf15 DATION OUT BASIC FIXED(15) CREATED(pcf15);

setValue: TASK MAIN;
   DCL x FIXED(15) INIT (4090);
   DCL ch FIXED(15);

   OPEN consol;
   OPEN consil;
   OPEN myPcf0;
   OPEN myPcf1;
   OPEN myPcf2;
   OPEN myPcf3;
   OPEN myPcf4;
   OPEN myPcf5;
   OPEN myPcf6;
   OPEN myPcf7;
   OPEN myPcf8;
   OPEN myPcf9;
   OPEN myPcf10;
   OPEN myPcf11;
   OPEN myPcf12;
   OPEN myPcf13;
   OPEN myPcf14;
   OPEN myPcf15;

   PUT 'PCF9685 Test started' TO consol BY A, SKIP;
   REPEAT
      PUT 'enter channel (0..15):' TO consol BY A;
      GET ch FROM consil BY F(6), SKIP;
      PUT 'enter value (Fixed(15): ' TO consol BY A, SKIP;
      GET x FROM consil BY F(6), SKIP;
      CALL setChannel(ch, x);
   END;
END; 

setChannel: PROC(ch FIXED(15), x FIXED(15));

   PUT 'set channel ',ch,' to value: ',x TO consol BY A,F(6),A,F(6), SKIP;
   CASE ch+1  ! ALT are counted stating at 1
    ALT SEND x TO myPcf0;
    ALT SEND x TO myPcf1;
    ALT SEND x TO myPcf2;
    ALT SEND x TO myPcf3;
    ALT SEND x TO myPcf4;
    ALT SEND x TO myPcf5;
    ALT SEND x TO myPcf6;
    ALT SEND x TO myPcf7;
    ALT SEND x TO myPcf8;
    ALT SEND x TO myPcf9;
    ALT SEND x TO myPcf10;
    ALT SEND x TO myPcf11;
    ALT SEND x TO myPcf12;
    ALT SEND x TO myPcf13;
    ALT SEND x TO myPcf14;
    ALT SEND x TO myPcf15;
    OUT PUT 'illegal channel (',ch,')' TO consol BY A,F(6), A, SKIP;
   FIN;
END;


MODEND;
